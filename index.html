<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SG 2026 Leave Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; padding-bottom: 80px; } /* Added padding for bottom bar */
        .day-cell { transition: all 0.15s ease-in-out; user-select: none; box-sizing: border-box; }
        .day-cell:not(.cursor-default):active { transform: scale(0.95); } /* Mobile touch feedback */
        .day-cell:not(.cursor-default):hover { transform: scale(1.05); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .half-day { background-image: linear-gradient(to right, #10b981 50%, #ffffff 50%); background-size: 100% 100%; background-repeat: no-repeat; color: #1f2937; }
        /* Loading overlay */
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Tool Selector Active State */
        .tool-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; ring-width: 2px; ring-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 font-medium">Syncing with Cloud...</p>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Sync Devices</h3>
            <p class="text-sm text-gray-500 mb-4">Enter the ID from your other device to load its data here.</p>
            <input type="text" id="manual-id-input" placeholder="Paste User ID here" class="w-full border p-2 rounded-lg mb-4 font-mono text-center tracking-widest uppercase">
            <div class="flex gap-2">
                <button id="cancel-sync-btn" class="flex-1 py-2 rounded-lg text-gray-500 hover:bg-gray-100">Cancel</button>
                <button id="confirm-sync-btn" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">Load Data</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-4 sm:p-8">
        <header class="mb-8 p-4 bg-white shadow-xl rounded-xl">
            <h1 class="text-2xl sm:text-4xl font-extrabold text-blue-600 tracking-tight">SG 2026 Leave Planner</h1>
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mt-2 gap-2">
                <p class="text-sm text-gray-500">Maximize your 2026 holidays.</p>
                <div class="flex items-center gap-2">
                    <div class="text-xs font-mono bg-gray-100 p-1.5 rounded text-gray-600">
                        ID: <span id="user-id-display">...</span>
                    </div>
                    <button id="copy-link-btn" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">Copy Link</button>
                    <button id="open-sync-btn" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 transition">Load ID</button>
                </div>
            </div>
            <div class="text-right mt-1">
                <span id="save-status" class="text-xs font-medium text-emerald-600">Connecting...</span>
            </div>
        </header>

        <section class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-white rounded-xl shadow-lg border-l-4 border-emerald-500">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-lg font-semibold text-gray-500">Annual Leave Balance</p>
                    <button id="edit-balance-btn" class="text-blue-500 hover:text-blue-700 p-1 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                </div>
                <div id="balance-display">
                    <div id="leave-balance" class="text-4xl font-bold mt-1 text-emerald-500">21</div>
                    <p id="total-days-display" class="text-sm text-gray-400">Remaining of 21 days</p>
                </div>
                <div id="balance-edit-form" class="hidden mt-2">
                    <input type="number" id="new-total-leave" class="w-full p-2 border rounded-lg text-lg" value="21" min="0" step="0.5">
                    <button id="save-balance-btn" class="mt-2 w-full bg-emerald-500 text-white p-2 rounded-lg">Save</button>
                </div>
            </div>
            
            <!-- Legend (Hidden on mobile to save space, relies on tool selector) -->
            <div class="md:col-span-2 p-4 bg-white rounded-xl shadow-lg hidden sm:block">
                <p class="text-lg font-semibold mb-2">Key</p>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs font-medium">
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 bg-blue-500"></span> Public Holiday</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 bg-gray-200"></span> Weekend</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 bg-yellow-400"></span> Suggested</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 bg-emerald-500"></span> Full Leave</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 half-day border border-gray-300"></span> Half Leave</div>
                    <div class="flex items-center"><span class="w-4 h-4 rounded-full mr-2 bg-red-500"></span> Blocked</div>
                </div>
            </div>
        </section>

        <main id="calendar-grid" class="space-y-8 pb-16"></main>
        
        <div id="toast" class="fixed bottom-24 right-4 p-3 rounded-xl bg-blue-600 text-white shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none">Notification</div>
    </div>

    <!-- Mobile-Friendly Action Bar -->
    <div class="fixed bottom-0 inset-x-0 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] p-2 z-40 border-t flex justify-around items-center safe-area-pb">
        <button class="tool-btn active flex flex-col items-center p-2 rounded-lg border border-transparent w-1/4" onclick="setTool(1)">
            <div class="w-5 h-5 bg-emerald-500 rounded-full mb-1"></div>
            <span class="text-[10px] font-bold">Full Day</span>
        </button>
        <button class="tool-btn flex flex-col items-center p-2 rounded-lg border border-transparent w-1/4" onclick="setTool(0.5)">
            <div class="w-5 h-5 half-day rounded-full border border-gray-300 mb-1"></div>
            <span class="text-[10px] font-bold">Half Day</span>
        </button>
        <button class="tool-btn flex flex-col items-center p-2 rounded-lg border border-transparent w-1/4" onclick="setTool(0)">
            <div class="w-5 h-5 bg-red-500 rounded-full mb-1"></div>
            <span class="text-[10px] font-bold">Block</span>
        </button>
        <button class="tool-btn flex flex-col items-center p-2 rounded-lg border border-transparent w-1/4" onclick="setTool(-1)">
            <div class="w-5 h-5 border-2 border-gray-300 rounded-full mb-1 bg-white relative">
                 <span class="absolute inset-0 flex items-center justify-center text-gray-400 text-xs">âœ•</span>
            </div>
            <span class="text-[10px] font-bold">Erase</span>
        </button>
    </div>

    <script type="module">
        // --- 1. IMPORT FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- 2. YOUR FIREBASE CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyCZJnFsvkXuEOwjRXFb06rcZ-w39L7Lv9c",
          authDomain: "leave-planner-2026-d0f0f.firebaseapp.com",
          projectId: "leave-planner-2026-d0f0f",
          storageBucket: "leave-planner-2026-d0f0f.firebasestorage.app",
          messagingSenderId: "887744260902",
          appId: "1:887744260902:web:cbfe5b640870f0d7166fe7",
          measurementId: "G-TF7Q1PHYV2"
        };

        // --- 3. APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const YEAR = 2026;
        let userId = null;
        let currentTool = 1; // Default tool: 1 (Full Day)
        
        // Expose setTool to window for HTML buttons
        window.setTool = function(val) {
            currentTool = val;
            // Update UI
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            // Find the button that called this (hacky but works for this simple setup)
            // or just iterate buttons based on index.
            const index = val === 1 ? 0 : val === 0.5 ? 1 : val === 0 ? 2 : 3;
            document.querySelectorAll('.tool-btn')[index].classList.add('active');
        };
        
        const state = {
            totalAnnualLeave: 21,
            leaveMap: new Map(),
            phMap: new Map(),
            suggestedLeaveMap: new Map(),
            isLoaded: false
        };

        // Data Setup
        const HOLIDAYS = [
            { date: '2026-01-01', name: 'New Year\'s Day', isObserved: false },
            { date: '2026-02-17', name: 'CNY 1', isObserved: false },
            { date: '2026-02-18', name: 'CNY 2', isObserved: false },
            { date: '2026-03-21', name: 'Hari Raya Puasa', isObserved: false },
            { date: '2026-04-03', name: 'Good Friday', isObserved: false },
            { date: '2026-05-01', name: 'Labour Day', isObserved: false },
            { date: '2026-05-27', name: 'Hari Raya Haji', isObserved: false },
            { date: '2026-05-31', name: 'Vesak Day', isObserved: false },
            { date: '2026-06-01', name: 'Vesak Off-in-Lieu', isObserved: true },
            { date: '2026-08-09', name: 'National Day', isObserved: false },
            { date: '2026-08-10', name: 'National Day Off-in-Lieu', isObserved: true },
            { date: '2026-11-08', name: 'Deepavali', isObserved: false },
            { date: '2026-11-09', name: 'Deepavali Off-in-Lieu', isObserved: true },
            { date: '2026-12-25', name: 'Christmas', isObserved: false },
        ];
        const SUGGESTIONS = [
            '2026-01-02', '2026-02-16', '2026-02-19', '2026-02-20', '2026-03-20', 
            '2026-05-25', '2026-05-26', '2026-05-28', '2026-05-29', '2026-08-07', 
            '2026-12-21', '2026-12-22', '2026-12-23', '2026-12-24'
        ];

        HOLIDAYS.forEach(h => state.phMap.set(h.date, h));
        SUGGESTIONS.forEach(d => state.suggestedLeaveMap.set(d, "Suggested Leave"));
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Core Functions
        const dateToKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        async function saveToCloud() {
            if (!userId) return;
            const data = {
                total: state.totalAnnualLeave,
                leaves: Object.fromEntries(state.leaveMap),
                updated: new Date().toISOString()
            };
            document.getElementById('save-status').textContent = "Saving...";
            try {
                await setDoc(doc(db, "planners", userId), data);
                document.getElementById('save-status').textContent = "Saved to Cloud";
            } catch (e) {
                console.error(e);
                document.getElementById('save-status').textContent = "Save Error";
            }
        }
        
        // Single Unified Interaction Handler
        function handleDateInteract(key, isWeekend, ph) {
            if(ph || isWeekend) return showToast("Cannot modify weekends or holidays");
            
            // Calculate remaining
            let used = 0;
            state.leaveMap.forEach(v => { if(v > 0) used += v; });
            const remaining = state.totalAnnualLeave - used;
            const currentVal = state.leaveMap.get(key) || 0;

            if (currentTool === -1) {
                // Erase Mode
                if (state.leaveMap.has(key)) {
                    state.leaveMap.delete(key);
                    showToast("Cleared");
                    render(); saveToCloud();
                }
                return;
            }

            // Apply Tool (Block, Half, Full)
            // Check balance impact
            let costDiff = 0;
            if (currentTool > 0) costDiff = currentTool;
            if (currentVal > 0) costDiff -= currentVal; // Credit back old value
            
            // If blocking (0), cost is 0. If erasing, handled above.
            if (currentTool === 0) costDiff = 0; 

            if (remaining - costDiff < 0 && currentTool > 0) {
                 return showToast("Balance depleted");
            }

            // Apply
            state.leaveMap.set(key, currentTool);
            render(); saveToCloud();
        }

        function render() {
            // Balance
            let used = 0;
            state.leaveMap.forEach(v => { if(v > 0) used += v; });
            const remaining = state.totalAnnualLeave - used;
            document.getElementById('leave-balance').textContent = remaining.toFixed(1);
            document.getElementById('total-days-display').textContent = `Remaining of ${state.totalAnnualLeave.toFixed(1)} days`;

            // Grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            for (let m = 0; m < 12; m++) {
                const section = document.createElement('section');
                section.className = 'bg-white rounded-xl shadow-md p-4';
                section.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center text-gray-700">${MONTHS[m]}</h2>`;
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'grid grid-cols-7 gap-1 text-center';
                
                // Header
                ['S','M','T','W','T','F','S'].forEach((d,i) => {
                    const h = document.createElement('div');
                    h.className = `text-xs font-bold ${i===0||i===6 ? 'text-red-500':''}`;
                    h.textContent = d;
                    daysContainer.appendChild(h);
                });

                // Spacers
                const firstDay = new Date(Date.UTC(YEAR, m, 1)).getUTCDay();
                for(let i=0; i<firstDay; i++) daysContainer.appendChild(document.createElement('div'));

                // Days
                const daysInMonth = new Date(Date.UTC(YEAR, m+1, 0)).getUTCDate();
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(Date.UTC(YEAR, m, d));
                    const key = dateToKey(date);
                    const dayOfWeek = date.getUTCDay();
                    const isWeekend = dayOfWeek===0 || dayOfWeek===6;
                    const ph = state.phMap.get(key);
                    const val = state.leaveMap.get(key);
                    
                    const el = document.createElement('div');
                    let classes = "day-cell h-14 rounded-lg flex flex-col items-center justify-center border text-sm relative cursor-pointer active:scale-95 transition-transform ";
                    
                    if (val === 1) classes += "bg-emerald-500 text-white border-emerald-600 shadow-md";
                    else if (val === 0.5) classes += "half-day border-emerald-500 shadow-md font-bold";
                    else if (val === 0) classes += "bg-red-500 text-white border-red-600 shadow-md";
                    else if (ph) classes += "bg-blue-500 text-white border-blue-600 cursor-default";
                    else if (isWeekend) classes += "bg-gray-100 text-gray-400 border-gray-100 cursor-default";
                    else if (state.suggestedLeaveMap.has(key)) classes += "bg-yellow-400 text-gray-900 border-yellow-500";
                    else classes += "bg-white hover:bg-blue-50 border-gray-100";
                    
                    el.className = classes;
                    el.innerHTML = `<span class="z-10">${d}</span>`;

                    // Labels
                    if(ph) el.innerHTML += `<div class="text-[8px] leading-none mt-1 opacity-90">${ph.isObserved?'OFF':'PH'}</div>`;
                    else if(val === 1) el.innerHTML += `<div class="text-[8px] leading-none mt-1">FULL</div>`;
                    else if(val === 0.5) el.innerHTML += `<div class="text-[8px] leading-none mt-1">HALF</div>`;
                    else if(val === 0) el.innerHTML += `<div class="text-[8px] leading-none mt-1">BLOCK</div>`;

                    // Interaction
                    if(!ph && !isWeekend) {
                        el.onclick = () => handleDateInteract(key, isWeekend, ph);
                    }
                    daysContainer.appendChild(el);
                }
                section.appendChild(daysContainer);
                grid.appendChild(section);
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => t.classList.add('opacity-0', 'pointer-events-none'), 2000);
        }

        // --- 4. INITIALIZATION ---
        
        function listenToUser(uid) {
             // Detach old listener if exists (not implemented for simplicity in this MVP, 
             // but effectively overwriting the onSnapshot call works for switching).
             
             userId = uid;
             document.getElementById('user-id-display').textContent = userId.substring(0,8);
             
             // Update URL without reload to make it shareable
             const newUrl = new URL(window.location);
             newUrl.searchParams.set('uid', userId);
             try {
                 window.history.pushState({}, '', newUrl);
             } catch (e) {
                 console.log("Could not update URL (likely due to sandbox environment):", e);
             }

             onSnapshot(doc(db, "planners", userId), (doc) => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen')?.remove(), 500);

                if (doc.exists()) {
                    const data = doc.data();
                    state.totalAnnualLeave = data.total || 21;
                    state.leaveMap = new Map(Object.entries(data.leaves || {}));
                    document.getElementById('save-status').textContent = "Synced";
                } else {
                    // New user, stick with defaults and save
                    saveToCloud();
                }
                state.isLoaded = true;
                render();
            });
        }

        async function init() {
            try {
                await signInAnonymously(auth);
                
                // Check for UID in URL
                const params = new URLSearchParams(window.location.search);
                const urlUid = params.get('uid');
                
                if (urlUid) {
                    // Use the ID from the URL
                    listenToUser(urlUid);
                } else {
                    // Generate new ID (using Auth UID)
                    listenToUser(auth.currentUser.uid);
                }

                // UI Listeners
                document.getElementById('edit-balance-btn').addEventListener('click', () => {
                    document.getElementById('balance-display').classList.add('hidden');
                    document.getElementById('balance-edit-form').classList.remove('hidden');
                    document.getElementById('new-total-leave').value = state.totalAnnualLeave;
                });
                document.getElementById('save-balance-btn').addEventListener('click', () => {
                    const val = parseFloat(document.getElementById('new-total-leave').value);
                    if(val >= 0) {
                        state.totalAnnualLeave = val;
                        document.getElementById('balance-display').classList.remove('hidden');
                        document.getElementById('balance-edit-form').classList.add('hidden');
                        render(); saveToCloud();
                    }
                });
                
                // Sync Modal Logic
                const modal = document.getElementById('sync-modal');
                document.getElementById('open-sync-btn').onclick = () => modal.classList.remove('hidden');
                document.getElementById('cancel-sync-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('confirm-sync-btn').onclick = () => {
                    const inputId = document.getElementById('manual-id-input').value.trim();
                    if(inputId) {
                        listenToUser(inputId);
                        modal.classList.add('hidden');
                        showToast("Switched to ID: " + inputId.substring(0,6));
                    }
                };
                
                // Copy Link Logic
                document.getElementById('copy-link-btn').onclick = () => {
                    const url = window.location.href;
                    navigator.clipboard.writeText(url).then(() => showToast("Link Copied!"));
                };

            } catch (e) {
                console.error("Init Error", e);
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500">Error: Check Console.</p>`;
            }
        }

        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Leave Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base Styles & Touch Optimization */
        body { font-family: ui-sans-serif, system-ui, sans-serif; -webkit-font-smoothing: antialiased; padding-bottom: 100px; }
        .day-cell { transition: all 0.1s ease-in-out; user-select: none; box-sizing: border-box; touch-action: manipulation; }
        .day-cell:active { transform: scale(0.92); } /* Satisfying touch feedback */
        .half-day { background-image: linear-gradient(to right, #10b981 50%, #ffffff 50%); background-size: 100% 100%; background-repeat: no-repeat; color: #1f2937; }
        
        /* Loading overlay */
        #loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; transition: opacity 0.5s; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Mode Switcher Active State */
        .mode-btn { opacity: 0.6; filter: grayscale(100%); transition: all 0.2s; border: 2px solid transparent; }
        .mode-btn.active { opacity: 1; filter: grayscale(0%); background-color: #f0fdf4; border-color: #10b981; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .mode-btn.active.block-mode { background-color: #fef2f2; border-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 font-medium">Syncing with Cloud...</p>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-2">Sync Devices</h3>
            <p class="text-sm text-gray-500 mb-4">Enter the ID from your other device to load its data here.</p>
            <input type="text" id="manual-id-input" placeholder="Paste User ID here" class="w-full border p-2 rounded-lg mb-4 font-mono text-center tracking-widest uppercase">
            <div class="flex gap-2">
                <button id="cancel-sync-btn" class="flex-1 py-2 rounded-lg text-gray-500 hover:bg-gray-100">Cancel</button>
                <button id="confirm-sync-btn" class="flex-1 py-2 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700">Load Data</button>
            </div>
        </div>
    </div>

    <div class="min-h-screen p-4 sm:p-8">
        <header class="mb-6 p-4 bg-white shadow-xl rounded-xl">
            <h1 class="text-2xl sm:text-4xl font-extrabold text-blue-600 tracking-tight">2026 Leave Planner</h1>
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mt-2 gap-2">
                <p class="text-xs sm:text-sm text-gray-500">Maximize your 2026 holidays.</p>
                <div class="flex items-center gap-2 flex-wrap">
                    <div class="text-[10px] sm:text-xs font-mono bg-gray-100 p-1.5 rounded text-gray-600">
                        ID: <span id="user-id-display">...</span>
                    </div>
                    <button id="copy-link-btn" class="text-[10px] sm:text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 transition">Copy Link</button>
                    <button id="open-sync-btn" class="text-[10px] sm:text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded hover:bg-gray-300 transition">Load ID</button>
                </div>
            </div>
            <div class="text-right mt-1">
                <span id="save-status" class="text-[10px] font-medium text-emerald-600">Connecting...</span>
            </div>
        </header>

        <section class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Balance -->
            <div class="p-4 bg-white rounded-xl shadow-lg border-l-4 border-emerald-500 relative overflow-hidden">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-lg font-semibold text-gray-500">Leave Balance</p>
                    <button id="edit-balance-btn" class="text-blue-500 hover:text-blue-700 p-1 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg></button>
                </div>
                <div id="balance-display">
                    <div id="leave-balance" class="text-4xl font-bold mt-1 text-emerald-500">21</div>
                    <p id="total-days-display" class="text-xs text-gray-400">of 21 days remaining</p>
                </div>
                <div id="balance-edit-form" class="hidden mt-2">
                    <input type="number" id="new-total-leave" class="w-full p-2 border rounded-lg text-lg" value="21" min="0" step="0.5">
                    <button id="save-balance-btn" class="mt-2 w-full bg-emerald-500 text-white p-2 rounded-lg">Save</button>
                </div>
            </div>
            
            <!-- Legend (Visible on Mobile now) -->
            <div class="md:col-span-2 p-3 bg-white rounded-xl shadow-lg">
                <p class="text-sm font-bold mb-2 text-gray-600">Calendar Key</p>
                <div class="grid grid-cols-3 sm:grid-cols-6 gap-2 text-[10px] sm:text-xs font-medium text-gray-600">
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 bg-blue-500"></span> Public Hol.</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 bg-gray-200"></span> Weekend</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 bg-yellow-400"></span> Suggested</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 bg-emerald-500"></span> Full Leave</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 half-day border border-gray-300"></span> Half Leave</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded-full mr-1.5 bg-red-500"></span> Blocked</div>
                </div>
            </div>
        </section>

        <main id="calendar-grid" class="space-y-6 pb-20"></main>
        
        <div id="toast" class="fixed bottom-28 right-4 p-3 rounded-xl bg-gray-800 text-white shadow-xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none text-sm">Notification</div>
    </div>

    <!-- Improved Action Bar (Mode Switcher) -->
    <div class="fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur-md shadow-[0_-4px_20px_rgba(0,0,0,0.1)] p-3 z-40 border-t border-gray-100 flex justify-center gap-4 safe-area-pb">
        
        <!-- Leave Mode Button -->
        <button id="mode-leave" class="mode-btn active flex items-center gap-3 px-6 py-3 rounded-xl bg-white w-full sm:w-auto justify-center" onclick="setMode('leave')">
            <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center text-emerald-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
            </div>
            <div class="text-left">
                <div class="text-xs font-bold text-gray-800">Book Leave</div>
                <div class="text-[10px] text-gray-500">Tap to cycle: Full &rarr; Half &rarr; Off</div>
            </div>
        </button>

        <!-- Block Mode Button -->
        <button id="mode-block" class="mode-btn block-mode flex items-center gap-3 px-6 py-3 rounded-xl bg-white w-full sm:w-auto justify-center" onclick="setMode('block')">
            <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>
            </div>
            <div class="text-left">
                <div class="text-xs font-bold text-gray-800">Block Dates</div>
                <div class="text-[10px] text-gray-500">Tap to block work days</div>
            </div>
        </button>

    </div>

    <script type="module">
        // --- 1. IMPORT FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- 2. FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCZJnFsvkXuEOwjRXFb06rcZ-w39L7Lv9c",
          authDomain: "leave-planner-2026-d0f0f.firebaseapp.com",
          projectId: "leave-planner-2026-d0f0f",
          storageBucket: "leave-planner-2026-d0f0f.firebasestorage.app",
          messagingSenderId: "887744260902",
          appId: "1:887744260902:web:cbfe5b640870f0d7166fe7",
          measurementId: "G-TF7Q1PHYV2"
        };

        // --- 3. APP LOGIC ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const YEAR = 2026;
        let userId = null;
        let activeMode = 'leave'; // 'leave' or 'block'
        
        // Expose setMode to window
        window.setMode = function(mode) {
            activeMode = mode;
            document.getElementById('mode-leave').classList.toggle('active', mode === 'leave');
            document.getElementById('mode-block').classList.toggle('active', mode === 'block');
        };
        
        const state = {
            totalAnnualLeave: 21,
            leaveMap: new Map(),
            phMap: new Map(),
            suggestedLeaveMap: new Map(),
            isLoaded: false
        };

        // Data Setup
        const HOLIDAYS = [
            { date: '2026-01-01', name: 'New Year\'s Day', isObserved: false },
            { date: '2026-02-17', name: 'Chinese New Year 1', isObserved: false },
            { date: '2026-02-18', name: 'Chinese New Year 2', isObserved: false },
            { date: '2026-03-21', name: 'Hari Raya Puasa', isObserved: false },
            { date: '2026-04-03', name: 'Good Friday', isObserved: false },
            { date: '2026-05-01', name: 'Labour Day', isObserved: false },
            { date: '2026-05-27', name: 'Hari Raya Haji', isObserved: false },
            { date: '2026-05-31', name: 'Vesak Day', isObserved: false },
            { date: '2026-06-01', name: 'Vesak Off-in-Lieu', isObserved: true },
            { date: '2026-08-09', name: 'National Day', isObserved: false },
            { date: '2026-08-10', name: 'National Day Off-in-Lieu', isObserved: true },
            { date: '2026-11-08', name: 'Deepavali', isObserved: false },
            { date: '2026-11-09', name: 'Deepavali Off-in-Lieu', isObserved: true },
            { date: '2026-12-25', name: 'Christmas Day', isObserved: false },
        ];
        const SUGGESTIONS = [
            '2026-01-02', '2026-02-16', '2026-02-19', '2026-02-20', '2026-03-20', 
            '2026-05-25', '2026-05-26', '2026-05-28', '2026-05-29', '2026-08-07', 
            '2026-12-21', '2026-12-22', '2026-12-23', '2026-12-24'
        ];

        HOLIDAYS.forEach(h => state.phMap.set(h.date, h));
        SUGGESTIONS.forEach(d => state.suggestedLeaveMap.set(d, "Suggested Leave"));
        const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        // Core Functions
        const dateToKey = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        
        async function saveToCloud() {
            if (!userId) return;
            const data = {
                total: state.totalAnnualLeave,
                leaves: Object.fromEntries(state.leaveMap),
                updated: new Date().toISOString()
            };
            document.getElementById('save-status').textContent = "Saving...";
            try {
                await setDoc(doc(db, "planners", userId), data);
                document.getElementById('save-status').textContent = "Saved";
            } catch (e) {
                console.error(e);
                document.getElementById('save-status').textContent = "Save Error";
            }
        }
        
        // --- NEW CYCLE INTERACTION LOGIC ---
        function handleDateInteract(key, isWeekend, ph) {
            if(ph || isWeekend) return showToast("Cannot modify weekends or holidays");
            
            // Current value
            const currentVal = state.leaveMap.get(key) || 0;
            let newVal = 0; // default to clear

            if (activeMode === 'leave') {
                // Cycle: Empty (0) -> Full (1.0) -> Half (0.5) -> Empty (0)
                if (currentVal === 0 || currentVal === 0.0) newVal = 1.0;
                else if (currentVal === 1.0) newVal = 0.5;
                else if (currentVal === 0.5) newVal = 0;
                // Note: If currently Blocked (0), treat as Empty and go to Full.
            } 
            else if (activeMode === 'block') {
                // Toggle: Empty/Leave -> Blocked (0) -> Empty
                // We use 0.001 or string 'block' typically, but here 0 is used for block?
                // Wait, previous code used 0 for block. But standard empty is undefined.
                // Let's ensure 0 means Blocked visually.
                // Actually, let's use -1 for Block to distinguish from Empty (undefined/null).
                // Refactoring Model: 1=Full, 0.5=Half, -1=Block, undefined=Empty.
                
                if (currentVal === -1) newVal = 0; // Clear block
                else newVal = -1; // Set block
            }

            // Check Balance (Only if adding leave)
            let used = 0;
            state.leaveMap.forEach(v => { if(v > 0) used += v; });
            const remaining = state.totalAnnualLeave - used;
            
            // Calculate cost difference of this specific change
            let costDiff = 0;
            if (newVal > 0) costDiff += newVal;
            if (currentVal > 0) costDiff -= currentVal;

            if (remaining - costDiff < 0) {
                 return showToast("Balance depleted");
            }

            // Apply
            if (newVal === 0) state.leaveMap.delete(key);
            else state.leaveMap.set(key, newVal);
            
            render(); saveToCloud();
        }

        function render() {
            // Balance
            let used = 0;
            state.leaveMap.forEach(v => { if(v > 0) used += v; });
            const remaining = state.totalAnnualLeave - used;
            document.getElementById('leave-balance').textContent = remaining.toFixed(1);
            document.getElementById('total-days-display').textContent = `Remaining of ${state.totalAnnualLeave.toFixed(1)} days`;

            // Grid
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            for (let m = 0; m < 12; m++) {
                const section = document.createElement('section');
                section.className = 'bg-white rounded-xl shadow-md p-4';
                section.innerHTML = `<h2 class="text-2xl font-bold mb-4 text-center text-gray-700">${MONTHS[m]}</h2>`;
                
                const daysContainer = document.createElement('div');
                daysContainer.className = 'grid grid-cols-7 gap-1 text-center';
                
                // Header
                ['S','M','T','W','T','F','S'].forEach((d,i) => {
                    const h = document.createElement('div');
                    h.className = `text-xs font-bold ${i===0||i===6 ? 'text-red-500':''}`;
                    h.textContent = d;
                    daysContainer.appendChild(h);
                });

                // Spacers
                const firstDay = new Date(Date.UTC(YEAR, m, 1)).getUTCDay();
                for(let i=0; i<firstDay; i++) daysContainer.appendChild(document.createElement('div'));

                // Days
                const daysInMonth = new Date(Date.UTC(YEAR, m+1, 0)).getUTCDate();
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(Date.UTC(YEAR, m, d));
                    const key = dateToKey(date);
                    const dayOfWeek = date.getUTCDay();
                    const isWeekend = dayOfWeek===0 || dayOfWeek===6;
                    const ph = state.phMap.get(key);
                    const val = state.leaveMap.get(key);
                    
                    const el = document.createElement('div');
                    let classes = "day-cell h-14 rounded-lg flex flex-col items-center justify-center border text-sm relative cursor-pointer active:scale-95 transition-transform ";
                    
                    if (val === 1) classes += "bg-emerald-500 text-white border-emerald-600 shadow-md font-bold";
                    else if (val === 0.5) classes += "half-day border-emerald-500 shadow-md font-bold";
                    else if (val === -1 || val === 0) classes += "bg-red-500 text-white border-red-600 shadow-md font-bold"; // 0 was block in old logic, -1 in new
                    else if (ph) classes += "bg-blue-500 text-white border-blue-600 cursor-default";
                    else if (isWeekend) classes += "bg-gray-100 text-gray-400 border-gray-100 cursor-default";
                    else if (state.suggestedLeaveMap.has(key)) classes += "bg-yellow-400 text-gray-900 border-yellow-500";
                    else classes += "bg-white hover:bg-blue-50 border-gray-100";
                    
                    el.className = classes;
                    el.innerHTML = `<span class="z-10">${d}</span>`;

                    // Labels
                    if(ph) el.innerHTML += `<div class="text-[8px] leading-none mt-1 opacity-90">${ph.isObserved?'OFF':'PH'}</div>`;
                    else if(val === 1) el.innerHTML += `<div class="text-[8px] leading-none mt-1">FULL</div>`;
                    else if(val === 0.5) el.innerHTML += `<div class="text-[8px] leading-none mt-1">HALF</div>`;
                    else if(val === -1 || val === 0) el.innerHTML += `<div class="text-[8px] leading-none mt-1">BLOCK</div>`;

                    // Interaction
                    if(!ph && !isWeekend) {
                        el.onclick = () => handleDateInteract(key, isWeekend, ph);
                    }
                    daysContainer.appendChild(el);
                }
                section.appendChild(daysContainer);
                grid.appendChild(section);
            }
        }

        // --- 4. INITIALIZATION ---
        
        function listenToUser(uid) {
             userId = uid;
             document.getElementById('user-id-display').textContent = userId.substring(0,8);
             
             // Update URL safely
             const newUrl = new URL(window.location);
             newUrl.searchParams.set('uid', userId);
             try { window.history.pushState({}, '', newUrl); } catch(e){}

             onSnapshot(doc(db, "planners", userId), (doc) => {
                document.getElementById('loading-screen').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-screen')?.remove(), 500);

                if (doc.exists()) {
                    const data = doc.data();
                    state.totalAnnualLeave = data.total || 21;
                    // Handle transition of old block logic (0) to new (-1) if needed, or just handle both in render
                    state.leaveMap = new Map(Object.entries(data.leaves || {}));
                    document.getElementById('save-status').textContent = "Synced";
                } else {
                    saveToCloud();
                }
                state.isLoaded = true;
                render();
            });
        }

        async function init() {
            try {
                await signInAnonymously(auth);
                const params = new URLSearchParams(window.location.search);
                const urlUid = params.get('uid');
                if (urlUid) listenToUser(urlUid);
                else listenToUser(auth.currentUser.uid);

                // Setup UI Listeners
                document.getElementById('edit-balance-btn').addEventListener('click', () => {
                    document.getElementById('balance-display').classList.add('hidden');
                    document.getElementById('balance-edit-form').classList.remove('hidden');
                    document.getElementById('new-total-leave').value = state.totalAnnualLeave;
                });
                document.getElementById('save-balance-btn').addEventListener('click', () => {
                    const val = parseFloat(document.getElementById('new-total-leave').value);
                    if(val >= 0) {
                        state.totalAnnualLeave = val;
                        document.getElementById('balance-display').classList.remove('hidden');
                        document.getElementById('balance-edit-form').classList.add('hidden');
                        render(); saveToCloud();
                    }
                });
                
                // Modal
                const modal = document.getElementById('sync-modal');
                document.getElementById('open-sync-btn').onclick = () => modal.classList.remove('hidden');
                document.getElementById('cancel-sync-btn').onclick = () => modal.classList.add('hidden');
                document.getElementById('confirm-sync-btn').onclick = () => {
                    const inputId = document.getElementById('manual-id-input').value.trim();
                    if(inputId) { listenToUser(inputId); modal.classList.add('hidden'); showToast("Switched ID"); }
                };
                document.getElementById('copy-link-btn').onclick = () => {
                    navigator.clipboard.writeText(window.location.href).then(() => showToast("Link Copied!"));
                };

            } catch (e) {
                console.error("Init Error", e);
                document.getElementById('loading-screen').innerHTML = `<p class="text-red-500">Error: Check Console.</p>`;
            }
        }

        init();
    </script>
</body>
</html>
